<img
    id="browser"
>
<div id="stats"></div>
<script>
$(function(){
    $.each(webfriend.stats, function(i, panel){
        panel.dom.style.cssText = 'position: relative';

        if (i <= 1) {
            panel.showPanel(i);
        } else {
            panel.showPanel(3);
        }

        $('#stats').append(panel.dom);
    });

    webfriend.setScreenTarget('#browser');
    var lastKnownButton = 0;

    $('#browser').on('contextmenu', function(e) {
        e.preventDefault();
    });

    $(document).on('keydown keyup keypress', function(e) {
        switch (e.key) {
        case 'F9':
            if (e.type == 'keydown' && editor) {
                editor.executeCurrentBuffer();
                return
            }

        default:
            if (e.target.nodeName === 'BODY') {
                webfriend.command('key', e.key, {
                    action:  (e.type === 'keyup' ? 'release' : 'press'),
                    alt:     e.altKey,
                    control: e.ctrlKey,
                    meta:    e.metaKey,
                    shift:   e.shiftKey,
                    keycode: e.keyCode,
                });

                e.preventDefault();
            }
        }
    });

    $('#browser').on('mousemove mousedown mouseup mousewheel', function(e) {
        var parentOffset = $(this).parent().offset();
        var relX = e.pageX - parentOffset.left;
        var relY = e.pageY - parentOffset.top;

        var args = {
            x: relX,
            y: relY,
        };

        var btn = e.button;

        if (e.type == 'mousemove') {
            btn = lastKnownButton;
        } else {
            lastKnownButton = btn;
        }


        args['count'] = e.detail;

        switch (btn) {
        case 1:
            args['button'] = 'middle';
            break;

        case 2:
            args['button'] = 'right';
            break;

        default:
            args['button'] = 'left';
            break;
        }

        switch (e.type) {
        case 'mousedown':
            $('*').blur();
            args['action'] = 'press';
            break;

        case 'mouseup':
            args['action'] = 'release';
            break;

        case 'mousewheel':
            args['action'] = 'scroll';
            args['wheelX'] = -1*e.originalEvent.wheelDeltaX;
            args['wheelY'] = -1*e.originalEvent.wheelDeltaY;

            break;
        default:
            args['action'] = 'move';
            break;
        }


        // webfriend.command('mouse', args);
        webfriend.command('inspect', {
            x: args.x,
            y: args.y,
        }).done(function(reply){
            console.debug(reply.scope.result);
        });

        e.preventDefault();
    });

    webfriend.connect().done(function(){
        console.info('Connected');

        /* window.onbeforeunload = webfriend.disconnect; */

        $(window).resize(webfriend.resizeScreen.bind(webfriend));
        webfriend.resizeScreen();

        $.ajax({
            url: '/api/tabs/current/info',
            success: function(data) {
                if ($.isPlainObject(data) && data.url) {
                    $('#urlbar input[name=url]').val(data.url);
                } else {
                    webfriend.command('go', location.protocol + '//' + location.host + '/home');
                }
            },
        });
    }).fail(function(){
        console.error('Connect failed');
    });
});
</script>